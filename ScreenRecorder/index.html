<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Recorder</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
</head>

<body>
    <nav class="navbar navbar-light" style="background-color: #1b7eff;">
        <div class="container-fluid">
            <a class="navbar-brand text-white">
                Screen<b class="">Recorder</b>
            </a>
        </div>
    </nav>

    <div class="container">
        <div class="row justify-content-around">
            <button class="col-5 col-sm-4 col-lg-2 mt-3 btn btn-outline-primary" id="start">
                Start Recording
            </button>
            <button class="col-5 col-sm-4 col-lg-2 mt-3 btn btn-outline-primary" id="stop" disabled>
                Stop Recording
            </button>
            <button class="col-5 col-sm-4 col-lg-2 mt-3 btn btn-outline-success" id="save" disabled>
                Save Recording
            </button>
            <button class="col-5 col-sm-4 col-lg-2 mt-3 btn btn-outline-danger" id="clear">
                Clear Recording
            </button>
        </div>
        <div class="row justify-content-center mt-5">
            <div class="col-12 col-md-10">
                <video class="w-100" autoplay controls />
            </div>
        </div>
    </div>

    <script>
        const start = document.getElementById("start");
        const stop = document.getElementById("stop");
        const save = document.getElementById("save");
        const clear = document.getElementById("clear");

        const video = document.querySelector("video");
        let recorder, stream, audioStream;

        const stopRecording = () => {
            stop.setAttribute("disabled", true);
            start.removeAttribute("disabled");

            if (recorder.state !== 'inactive') recorder.stop();
            if (stream.getVideoTracks()[0].state !== 'inactive') {
                stream.getVideoTracks()[0].stop()
                audioStream.getAudioTracks()[0].stop()
            }
        }

        async function startRecording() {
            stream = await navigator.mediaDevices.getDisplayMedia({
                video: { mediaSource: "screen" },
                // audio: true
            });

            audioStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true })
            const AV_Stream = new MediaStream([...stream.getTracks(), ...audioStream.getAudioTracks()])
            recorder = new MediaRecorder(AV_Stream);

            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = e => {
                stopRecording();

                const completeBlob = new Blob(chunks, { type: "video/mp4" });
                video.src = URL.createObjectURL(completeBlob);

                save.removeAttribute("disabled");
            };

            recorder.start();
        }

        save.addEventListener('click', () => {
            const aElem = document.createElement('a');
            aElem.href = video.src;
            const dateStr = new Date().toDateString()
            const fileName = (prompt("Enter name of File for Saving") || "Screen Recording") + " - " + dateStr
            aElem.download = fileName;
            aElem.click()
        })

        clear.addEventListener("click", () => {
            const _clear = confirm("You will loss your recording. Do you want to continue ?")
            if (_clear) location.reload()
        })

        start.addEventListener("click", () => {
            start.setAttribute("disabled", true);
            stop.removeAttribute("disabled");

            startRecording();
        });

        stop.addEventListener("click", stopRecording);



    </script>
</body>

</html>